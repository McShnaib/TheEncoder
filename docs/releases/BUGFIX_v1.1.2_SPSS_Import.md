# Bug Fix Report - Version 1.1.2

## Issues: SPSS Cannot Import Downloaded Excel Files

### Problem 1: Excel File Appears Empty in SPSS
**Symptom:** When trying to import the downloaded `encoded_data.xlsx` in SPSS, it appears empty or gives errors. Manual workaround required: open file in Excel, save as a new file, then it works.

**Root Cause:** 
- Using `openpyxl` engine creates Excel files that SPSS has trouble reading
- Missing proper Excel metadata/formatting that SPSS expects
- File structure not optimally formatted for SPSS import

---

### Problem 2: GET DATA Command Fails with Error 2052
**Symptom:** Even when files are in the same folder, SPSS gives Error 2052:

```
Error (2052) Error accessing the Excel file. The file may be open by another application.
* File: "encoded_data.xlsx"
```

**Root Cause:**
- SPSS doesn't automatically use the `.sps` file's directory as working directory
- Relative path `"encoded_data.xlsx"` doesn't work without setting working directory
- SPSS looks in its default directory (usually different from where files are saved)

---

## Solutions Implemented

### Solution 1: Switch to xlsxwriter Engine

Changed Excel file generation to use `xlsxwriter` engine with proper formatting:

**Before (v1.1.1):**
```python
df.to_excel(output_path, sheet_name=sheet_name, index=False, engine='openpyxl')
```

**After (v1.1.2):**
```python
with pd.ExcelWriter(output_path, engine='xlsxwriter') as writer:
    df.to_excel(writer, sheet_name=sheet_name, index=False)
    
    # Set column widths for readability
    workbook = writer.book
    worksheet = writer.sheets[sheet_name]
    for idx, col in enumerate(df.columns):
        max_len = max(df[col].astype(str).apply(len).max(), len(str(col)))
        worksheet.set_column(idx, idx, min(max_len + 2, 50))
```

**Benefits:**
- ‚úÖ Better SPSS compatibility (xlsxwriter creates more "standard" Excel files)
- ‚úÖ Proper column width formatting
- ‚úÖ No need to open/resave in Excel manually
- ‚úÖ Direct import to SPSS works

---

### Solution 2: Add CD Command to Set Working Directory

Added a `CD` (Change Directory) command to the `.sps` file that users must edit:

**Generated .sps file now includes:**

```spss
* Auto-generated by SPSS Prep Tool
* This script imports encoded data and applies value labels
* Original column names are preserved as variable labels
*
* IMPORTANT INSTRUCTIONS:
* 1. Save both this .sps file and encoded_data.xlsx to the SAME folder
* 2. Edit the CD command below to point to that folder
* 3. Run this script in SPSS
*
* Example: If you saved files to C:\Users\YourName\Documents\MySurvey\
*          Change the CD command to: CD 'C:\Users\YourName\Documents\MySurvey'.

* SET THE WORKING DIRECTORY (edit this path!):
CD 'C:\Users\YourName\Documents'.
* Change the path above to where you saved the files!

* Import the data:
GET DATA
  /TYPE=XLSX
  /FILE="encoded_data.xlsx"
  /SHEET=name "Sheet1"
  /READNAMES=ON.
```

**How it works:**
1. User downloads both files
2. Saves them to a folder (e.g., `C:\MySurvey\`)
3. Opens `.sps` in text editor
4. Edits the CD command: `CD 'C:\MySurvey'.`
5. Runs in SPSS - now SPSS knows where to find the Excel file!

---

### Solution 3: Clear UI Instructions

Added step-by-step instructions in the Streamlit app after file generation:

```
üìã Next Steps:
1. Download both files using the buttons above
2. Save them to the SAME folder on your computer
3. Open the .sps file in a text editor (Notepad, etc.)
4. Edit the CD command to point to your folder
5. Save the .sps file
6. Open the .sps file in IBM SPSS
7. Run the script (Ctrl+A, then Ctrl+R)

‚ö†Ô∏è Important: The CD command tells SPSS where to find your Excel file.
If you skip step 4, you'll get Error 2052!
```

---

## Example: Complete Workflow

### Step-by-Step User Experience

1. **In the app:**
   - Upload survey data
   - Configure columns
   - Click "Apply Encoding"
   - Download both files

2. **Save files together:**
   ```
   C:\Users\Ahmed\Documents\MySurvey\
   ‚îú‚îÄ‚îÄ encoded_data.xlsx
   ‚îî‚îÄ‚îÄ auto_import.sps
   ```

3. **Edit .sps file:**
   - Open `auto_import.sps` in Notepad
   - Find line: `CD 'C:\Users\YourName\Documents'.`
   - Change to: `CD 'C:\Users\Ahmed\Documents\MySurvey'.`
   - Save file

4. **Run in SPSS:**
   - Open `auto_import.sps` in SPSS
   - Press Ctrl+A (select all)
   - Press Ctrl+R (run)
   - ‚úÖ Data imports successfully!

---

## Technical Details

### Why xlsxwriter Works Better

**openpyxl:**
- Creates Excel 2010+ format
- Sometimes includes extra metadata that confuses SPSS
- Column widths not properly set

**xlsxwriter:**
- Creates simpler, more compatible Excel format
- Better control over formatting
- SPSS reads it reliably
- Properly set column widths

### Why CD Command is Necessary

**SPSS working directory behavior:**
- SPSS has a "current directory" separate from where files are opened
- Opening a `.sps` file doesn't change SPSS's working directory
- Relative paths like `"encoded_data.xlsx"` look in the working directory
- Solution: Explicitly set working directory with `CD` command

**Alternative considered (rejected):**
- Using absolute paths: Would work but path would be wrong after download
- Using FILE HANDLE: More complex, less user-friendly
- Telling user to open files from specific directory: Confusing

---

## Files Modified

1. **encoder.py**
   - `save_encoded_excel()`: Changed engine from openpyxl to xlsxwriter
   - Added column width formatting
   - Better SPSS compatibility

2. **sps_generator.py**
   - Added comprehensive header comments with instructions
   - Added CD command with placeholder path
   - Added example for users
   - Made instructions very clear and actionable

3. **app.py**
   - Added detailed step-by-step instructions after download
   - Warning about CD command importance
   - Tips for keeping files organized

---

## Test Results

```
pytest tests/test_encoding.py -v
===========================
‚úÖ 26 tests PASSED
‚è±Ô∏è  0.59 seconds
```

All existing tests still pass. No new tests needed as this is primarily a file format and documentation fix.

---

## User Impact

### Before (Broken)
‚ùå Excel file appears empty in SPSS  
‚ùå Manual workaround: open ‚Üí save as ‚Üí import  
‚ùå GET DATA fails with Error 2052  
‚ùå Confusing error messages  
‚ùå No clear instructions  

### After (Fixed)
‚úÖ Excel file imports directly into SPSS  
‚úÖ No manual workaround needed  
‚úÖ GET DATA works after editing CD command  
‚úÖ Clear error prevention  
‚úÖ Step-by-step instructions in app and .sps file  

---

## Common User Mistakes Prevented

### Mistake 1: Not editing CD command
**Prevented by:**
- Large comment block in .sps file
- Warning in app UI
- Example provided

### Mistake 2: Saving files in different folders
**Prevented by:**
- Explicit instruction to save together
- Tip about keeping files organized
- Clear folder example

### Mistake 3: Wrong path format
**Prevented by:**
- Example with proper backslashes
- Clear format: `CD 'C:\Path\To\Folder'.`

---

## Future Improvements

Possible enhancements for future versions:

1. **Auto-detect save location:**
   - If we could detect where user saves files, we could pre-fill the CD command
   - Browser security prevents this currently

2. **Generate separate .sps files:**
   - One with absolute paths (no CD needed)
   - One with relative paths (requires CD)
   - User chooses which to download

3. **SPSS macro variable:**
   - Use `DEFINE !DATAPATH` macro
   - User sets path once at top
   - Used throughout script

---

## Backward Compatibility

- Old `.xlsx` files: Need to be regenerated with new version
- Old `.sps` files: Missing CD command, should regenerate
- No API changes
- All features still work

---

## Verification Checklist

To verify fixes work:

- [x] Generate encoded files
- [x] Download both files
- [x] Save to test folder
- [x] Edit CD command in .sps
- [x] Open .sps in SPSS
- [x] Run script
- [x] Check: Data imports without errors
- [x] Check: VALUE LABELS applied correctly
- [x] Check: VARIABLE LABELS show original names
- [x] Check: VARIABLE LEVEL sets measure types

---

**Version:** 1.1.2  
**Date:** October 5, 2025  
**Status:** ‚úÖ RESOLVED - SPSS import now works reliably  
**Tests:** 26/26 passing ‚úÖ

