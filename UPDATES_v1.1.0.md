# Version 1.1.0 - Major Updates

## 🎉 Summary

Major update addressing Arabic language support, SPSS terminology alignment, and improved file path handling.

---

## ✅ Issues Fixed

### 1. ✅ .sps File Path Issue - FIXED
**Problem:** Generated `.sps` files used temp directory paths that didn't match where users saved files.

**Solution:** 
- `.sps` files now use **relative paths** (just the filename)
- Works automatically when both files are in the same folder
- Added helpful comment in `.sps` header

**Before:**
```spss
GET DATA
  /TYPE=XLSX
  /FILE="C:\\Temp\\encoded_data.xlsx"
```

**After:**
```spss
* NOTE: Keep this .sps file and encoded_data.xlsx in the same folder
GET DATA
  /TYPE=XLSX
  /FILE="encoded_data.xlsx"
```

---

### 2. ✅ Arabic Variable Names - FIXED
**Problem:** Arabic column names all became "v_" causing duplicate variable names.

**Solution:**
- New `generate_unique_var_names()` function assigns unique names: `var1`, `var2`, `var3`, etc.
- Handles any non-ASCII text (Arabic, Chinese, etc.)
- Pre-generates all names at once to ensure uniqueness

**Before:**
```
السؤال الأول → v_
السؤال الثاني → v_ (DUPLICATE!)
```

**After:**
```
السؤال الأول → var1
السؤال الثاني → var2
السؤال الثالث → var3
```

---

### 3. ✅ Arabic Text Encoding - FIXED
**Problem:** Arabic text in VALUE LABELS appeared as "?????" in downloaded `.sps` files.

**Solution:**
- Changed file encoding from UTF-8 to **UTF-8 with BOM** (`utf-8-sig`)
- BOM tells SPSS to use proper Unicode encoding
- Applied to both file save and download button

**Technical Details:**
- Updated `save_sps_file()` to use `encoding='utf-8-sig'`
- Download button now encodes with `.encode('utf-8-sig')`

---

### 4. ✅ SPSS Terminology - UPDATED
**Problem:** UI used "Likert" and "Nominal" which doesn't match SPSS terminology.

**Solution:**
- Changed to SPSS standard "Measure" types:
  - **Ordinal**: Ordered categories (Likert scales, education levels)
  - **Nominal**: Unordered categories (colors, countries)
  - **Scale**: Continuous numeric variables
  - **Ignore**: Don't encode

**UI Changes:**
- "Encoding Type" → "Measure (SPSS Variable Level)"
- Helpful tooltips explain each type
- Auto-detection improved:
  - Numeric columns → Scale
  - Likert-like → Ordinal
  - Others → Nominal

---

### 5. ✅ VARIABLE LEVEL Command - ADDED
**Problem:** Measure types weren't set in SPSS, had to be set manually.

**Solution:**
- Added `VARIABLE LEVEL` block to `.sps` files
- Automatically sets each variable's measure type
- Groups variables by type for cleaner syntax

**Example Output:**
```spss
VARIABLE LEVEL
  var1 var2 var3 (ORDINAL) /
  var4 var5 (NOMINAL) /
  var6 var7 (SCALE).
```

---

## 📝 Technical Changes

### Modified Files

1. **utils.py**
   - `sanitize_variable_name()`: Now handles non-ASCII better, returns fallback instead of empty
   - `generate_unique_var_names()`: New function for batch unique name generation

2. **sps_generator.py**
   - `generate_sps_syntax()`: Added `use_relative_path` and `measure_types` parameters
   - `generate_variable_level_block()`: New function to create VARIABLE LEVEL syntax
   - `save_sps_file()`: Changed encoding to UTF-8-sig

3. **encoder.py**
   - `ColumnConfig`: Updated default from 'Likert' to 'Ordinal'
   - `get_mapping()`: Added handling for 'Scale' type (no encoding needed)

4. **app.py**
   - Updated UI: "Encoding Type" → "Measure (SPSS Variable Level)"
   - Added unique name generation on file upload
   - Options changed: Likert → Ordinal, added Scale
   - Download button: Now uses UTF-8-sig encoding
   - Pass `measure_types` to SPSS syntax generator

5. **tests/test_encoding.py**
   - Updated all 'Likert' references to 'Ordinal'
   - Fixed `test_starts_with_letter()` for new sanitization behavior
   - All 20 tests passing ✅

---

## 🧪 Test Results

```
pytest tests/test_encoding.py -v
===========================
✅ 20 PASSED
⏱️  0.59 seconds
```

All tests updated and passing!

---

## 📊 Example SPSS Syntax (v1.1.0)

```spss
* Auto-generated by SPSS Prep Tool
* This script imports encoded data and applies value labels
* Original column names are preserved as variable labels
* NOTE: Keep this .sps file and encoded_data.xlsx in the same folder
* Then open this .sps file from that folder in SPSS

GET DATA
  /TYPE=XLSX
  /FILE="encoded_data.xlsx"
  /SHEET=name "Sheet1"
  /READNAMES=ON.

VALUE LABELS
  var1 1 'غير راض' 2 'محايد' 3 'راض' 4 'راض جداً' /
  var2 1 'أبداً' 2 'نادراً' 3 'أحياناً' 4 'غالباً' 5 'دائماً'.

VARIABLE LABELS
  var1 'ما مدى رضاك عن الخدمة؟' /
  var2 'كم مرة تستخدم المنتج؟'.

VARIABLE LEVEL
  var1 var2 (ORDINAL) /
  var3 var4 (NOMINAL) /
  var5 (SCALE).

EXECUTE.
```

---

## 🎯 User Impact

### What Users Need to Do

1. **Re-encode existing files** if they have Arabic text
2. **Download new .sps files** - old ones have wrong paths and no VARIABLE LEVEL
3. **Keep both files in same folder** when downloading

### What Users Get

- ✅ Arabic text displays correctly in SPSS
- ✅ No duplicate variable names
- ✅ .sps files work without path editing
- ✅ Proper SPSS terminology throughout
- ✅ Measure types automatically set

---

## 🔄 Backward Compatibility

- Old .xlsx files can be re-encoded
- Old configs auto-convert: "Likert" → "Ordinal"  
- All existing features still work
- No breaking changes to API

---

## 📚 Documentation Updates Needed

- [ ] Update README.md with new terminology
- [ ] Update QUICKSTART.md with Arabic example
- [ ] Update screenshots showing new "Measure" dropdown
- [ ] Add Arabic support note to features list

---

## 🚀 Next Steps

1. Update main documentation
2. Add Arabic sample file
3. Consider transliteration option for Arabic names
4. Add more measure type auto-detection heuristics

---

**Version:** 1.1.0  
**Date:** October 5, 2025  
**Status:** ✅ COMPLETE - ALL ISSUES RESOLVED

